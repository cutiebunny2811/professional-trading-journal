<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ProTrade Journal</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #e4e4e7; padding-bottom: 40px;}
        input, select, textarea { background-color: #18181b; border-color: #27272a; color: white; }
        input:focus, select:focus, textarea:focus { border-color: #10b981; outline: none; ring: 0; }
        .tab-active { background-color: #e4e4e7; color: #09090b; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tab-inactive { background-color: #18181b; color: #71717a; }
        .tab-inactive:hover { background-color: #27272a; color: #d4d4d8; }
        /* Calendar Hover Effect */
        .cal-day:hover { border-color: #34d399; cursor: pointer; background-color: #064e3b; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 space-y-6 fade-in">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-emerald-500 to-teal-600 p-2.5 rounded-xl shadow-lg shadow-emerald-900/20">
                    <i data-lucide="bar-chart-2" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">ProTrade <span class="text-zinc-500 font-medium">Journal</span></h1>
                    <p class="text-xs text-zinc-500">Professional Trading Log</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                 <button onclick="toggleModal('modal-settings')" class="p-2.5 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 text-zinc-400 transition-colors" title="Backup / Restore">
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
                <button onclick="toggleModal('modal-funds')" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 text-zinc-300 text-sm font-bold transition-colors">
                    <i data-lucide="wallet" class="w-4 h-4"></i> Manage Funds
                </button>
                <button onclick="openAddTrade()" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg shadow-emerald-900/20 transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add Trade
                </button>
            </div>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="setTab('All')" id="tab-All" class="px-5 py-2 rounded-lg text-sm transition-all tab-active">Overview</button>
            <button onclick="setTab('Day Trade')" id="tab-Day Trade" class="px-5 py-2 rounded-lg text-sm transition-all tab-inactive">Day Trade</button>
            <button onclick="setTab('Swing Trade')" id="tab-Swing Trade" class="px-5 py-2 rounded-lg text-sm transition-all tab-inactive">Swing Trade</button>
            <button onclick="setTab('Options')" id="tab-Options" class="px-5 py-2 rounded-lg text-sm transition-all tab-inactive">Options</button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-zinc-900 border border-zinc-800 p-5 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-2"><span class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">Portfolio Value</span><i data-lucide="briefcase" class="w-4 h-4 text-purple-500"></i></div>
                <div id="stat-port-val" class="text-3xl font-black text-white">$0.00</div>
                <div id="stat-invested" class="text-[10px] text-zinc-600 mt-1">Cap: $0.00</div>
            </div>
            <div class="bg-zinc-900 border border-zinc-800 p-5 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-2"><span class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">Net Profit</span><i data-lucide="dollar-sign" class="w-4 h-4 text-emerald-500"></i></div>
                <div id="stat-net-profit" class="text-3xl font-black text-white">$0.00</div>
                <div class="text-[10px] text-zinc-600 mt-1">Realized P/L</div>
            </div>
            <div class="bg-zinc-900 border border-zinc-800 p-5 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-2"><span class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">ROI</span><i data-lucide="trending-up" class="w-4 h-4 text-emerald-500"></i></div>
                <div id="stat-roi" class="text-3xl font-black text-emerald-500">0.00%</div>
                <div class="text-[10px] text-zinc-600 mt-1">Return on Investment</div>
            </div>
            <div class="bg-zinc-900 border border-zinc-800 p-5 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-2"><span class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">Win Rate</span><i data-lucide="target" class="w-4 h-4 text-blue-500"></i></div>
                <div id="stat-win-rate" class="text-3xl font-black text-blue-500">0.0%</div>
                <div id="stat-total-trades" class="text-[10px] text-zinc-600 mt-1">0 Trades</div>
            </div>
            
            <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-xl"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Avg Win</p><p id="stat-avg-win" class="text-lg font-bold text-emerald-400">$0.00</p></div>
             <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-xl"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Avg Loss</p><p id="stat-avg-loss" class="text-lg font-bold text-rose-400">$0.00</p></div>
             <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-xl"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Profit Factor</p><p id="stat-pf" class="text-lg font-bold text-orange-400">0.00</p></div>
             <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-xl"><p class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Largest Win</p><p id="stat-max-win" class="text-lg font-bold text-emerald-400">$0.00</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-white flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-zinc-500"></i> Performance Calendar</h3>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span id="cal-month-year" class="text-sm font-bold text-white w-32 text-center pt-1">...</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div class="grid grid-cols-7 mb-2 text-center">
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Sun</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Mon</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Tue</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Wed</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Thu</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Fri</div>
                    <div class="text-[10px] font-bold text-zinc-600 uppercase">Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 md:gap-2 h-96"></div>
            </div>

            <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 flex flex-col h-[500px]">
                <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-zinc-500"></i> Recent Activity <span id="list-filter-label" class="text-xs text-zinc-600 bg-zinc-800 px-2 py-0.5 rounded ml-auto">All</span></h3>
                <div id="tx-list" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                    </div>
            </div>
        </div>

    </div>

    <div id="modal-trade" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-zinc-900 w-full max-w-md rounded-3xl border border-zinc-800 p-6 space-y-4 shadow-2xl">
            <h3 class="text-lg font-bold text-white">Record Trade</h3>
            <div class="grid grid-cols-2 gap-3">
                <input type="date" id="t-date" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white">
                <select id="t-type" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white font-bold text-indigo-400">
                    <option value="Day Trade">Day Trade</option>
                    <option value="Swing Trade">Swing Trade</option>
                    <option value="Options">Options</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="t-ticker" placeholder="Ticker (e.g. TSLA)" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white uppercase font-bold">
                <input type="text" id="t-strategy" placeholder="Strategy (e.g. Breakout)" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input type="number" id="t-pl" placeholder="P/L ($)" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white font-bold">
                <input type="number" id="t-roi" placeholder="ROI (%)" class="bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white">
            </div>
            <textarea id="t-notes" rows="2" placeholder="Notes..." class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white resize-none"></textarea>
            
            <div class="flex gap-2 pt-2">
                <button onclick="toggleModal('modal-trade')" class="flex-1 py-3 rounded-xl bg-zinc-800 text-zinc-400 font-bold text-sm">Cancel</button>
                <button onclick="saveTrade()" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold text-sm">Save Trade</button>
            </div>
        </div>
    </div>

    <div id="modal-funds" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-zinc-900 w-full max-w-sm rounded-3xl border border-zinc-800 p-6 space-y-4 shadow-2xl">
            <h3 class="text-lg font-bold text-white">Manage Funds</h3>
            
            <div>
                <label class="text-xs text-zinc-500 uppercase font-bold block mb-2">Allocated Strategy</label>
                <select id="f-strategy" class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-sm text-white font-bold">
                    <option value="Day Trade">Day Trade</option>
                    <option value="Swing Trade">Swing Trade</option>
                    <option value="Options">Options</option>
                </select>
                <p class="text-[10px] text-zinc-600 mt-1">Funds will be added to this strategy's capital.</p>
            </div>

            <div>
                <label class="text-xs text-zinc-500 uppercase font-bold block mb-2">Deposit / Withdraw</label>
                <input type="number" id="f-amount" placeholder="Amount ($)" class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-white font-bold text-lg">
                <p class="text-[10px] text-zinc-600 mt-1">Positive for Deposit, Negative for Withdrawal</p>
            </div>

            <div class="flex gap-2 pt-2">
                <button onclick="toggleModal('modal-funds')" class="flex-1 py-3 rounded-xl bg-zinc-800 text-zinc-400 font-bold text-sm">Cancel</button>
                <button onclick="saveFund()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-sm">Update Balance</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-zinc-900 w-full max-w-sm rounded-3xl border border-zinc-800 p-6 space-y-4 shadow-2xl">
            <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="save" class="w-4 h-4 text-zinc-400"></i> Backup Data</h3>
            <div class="space-y-3">
                <button onclick="exportData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700/50 transition-all group">
                    <div class="text-left"><div class="font-bold text-white text-sm group-hover:text-emerald-400">Copy Data</div><div class="text-[10px] text-zinc-500">Save to clipboard</div></div>
                    <i data-lucide="copy" class="w-5 h-5 text-zinc-500 group-hover:text-emerald-400"></i>
                </button>
                <button onclick="importData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700/50 transition-all group">
                    <div class="text-left"><div class="font-bold text-white text-sm group-hover:text-blue-400">Import Data</div><div class="text-[10px] text-zinc-500">Restore from text</div></div>
                    <i data-lucide="download" class="w-5 h-5 text-zinc-500 group-hover:text-blue-400"></i>
                </button>
                 <button onclick="resetData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-rose-900/10 hover:bg-rose-900/20 border border-rose-900/30 transition-all mt-4 group">
                    <div class="text-left"><div class="font-bold text-rose-400 text-sm">Reset All</div><div class="text-[10px] text-rose-500/60">Clear everything</div></div>
                    <i data-lucide="trash-2" class="w-5 h-5 text-rose-500/60 group-hover:text-rose-500"></i>
                </button>
            </div>
            <button onclick="toggleModal('modal-settings')" class="w-full py-3 rounded-xl bg-zinc-950 border border-zinc-800 text-zinc-400 font-bold text-sm mt-2">Close</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- STATE ---
        let trades = JSON.parse(localStorage.getItem('ptj_trades')) || [];
        // Balances tracked PER STRATEGY
        let balances = JSON.parse(localStorage.getItem('ptj_balances')) || {
            "Day Trade": 0,
            "Swing Trade": 0,
            "Options": 0
        };
        
        let currentFilter = 'All'; 
        let currentDate = new Date();
        const moneyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

        // --- INIT ---
        renderAll();

        function renderAll() {
            renderStats();
            renderCalendar();
            renderTrades();
        }

        // --- TABS LOGIC ---
        function setTab(tab) {
            currentFilter = tab;
            ['All', 'Day Trade', 'Swing Trade', 'Options'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(t === tab) btn.className = "px-5 py-2 rounded-lg text-sm transition-all tab-active shadow-lg shadow-zinc-900/20";
                else btn.className = "px-5 py-2 rounded-lg text-sm transition-all tab-inactive hover:bg-zinc-800 hover:text-zinc-300";
            });
            document.getElementById('list-filter-label').innerText = tab;
            renderAll();
        }

        // --- CORE FUNCTIONS ---
        function toggleModal(id) {
            const m = document.getElementById(id);
            if (m.classList.contains('hidden')) {
                m.classList.remove('hidden');
                m.classList.add('flex');
                if(id==='modal-trade' && !document.getElementById('t-date').value) document.getElementById('t-date').valueAsDate = new Date();
            } else {
                m.classList.add('hidden');
                m.classList.remove('flex');
            }
        }

        // ADDED: Accept date parameter to pre-fill from Calendar click
        function openAddTrade(dateStr = null) { 
            toggleModal('modal-trade');
            if(dateStr) {
                document.getElementById('t-date').value = dateStr;
            } else {
                document.getElementById('t-date').valueAsDate = new Date();
            }
        }

        function saveTrade() {
            const date = document.getElementById('t-date').value;
            const ticker = document.getElementById('t-ticker').value.toUpperCase();
            const pl = parseFloat(document.getElementById('t-pl').value);
            const roi = parseFloat(document.getElementById('t-roi').value) || 0;
            const type = document.getElementById('t-type').value;
            const strategy = document.getElementById('t-strategy').value;
            const notes = document.getElementById('t-notes').value;

            if(!date || !ticker || isNaN(pl)) return alert("Please fill Date, Ticker and P/L");

            const trade = { id: Date.now(), date, ticker, pl, roi, type, strategy, notes };
            trades.push(trade);
            trades.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            saveData();
            renderAll();
            toggleModal('modal-trade');
            
            // Clear inputs
            document.getElementById('t-ticker').value = ''; document.getElementById('t-pl').value = '';
            document.getElementById('t-roi').value = ''; document.getElementById('t-strategy').value = '';
            document.getElementById('t-notes').value = '';
        }

        function saveFund() {
            const amt = parseFloat(document.getElementById('f-amount').value);
            const strat = document.getElementById('f-strategy').value;
            
            if(isNaN(amt)) return alert("Invalid amount");
            
            // Update specific strategy balance
            if(!balances[strat]) balances[strat] = 0;
            balances[strat] += amt;

            localStorage.setItem('ptj_balances', JSON.stringify(balances));
            saveData();
            renderStats(); 
            toggleModal('modal-funds');
            document.getElementById('f-amount').value = '';
        }

        function deleteTrade(id) {
            if(confirm("Delete this trade?")) {
                trades = trades.filter(t => t.id !== id);
                saveData();
                renderAll();
            }
        }

        function getFilteredTrades() {
            if (currentFilter === 'All') return trades;
            return trades.filter(t => t.type === currentFilter);
        }

        // --- RENDERING ---
        function renderStats() {
            const filtered = getFilteredTrades();
            let netProfit = 0;
            let wins = 0;
            let losses = 0;
            let totalWinAmt = 0;
            let totalLossAmt = 0;
            let maxWin = 0;

            filtered.forEach(t => {
                netProfit += t.pl;
                if(t.pl > 0) { 
                    wins++; totalWinAmt += t.pl; 
                    if(t.pl > maxWin) maxWin = t.pl;
                }
                else if(t.pl < 0) { losses++; totalLossAmt += Math.abs(t.pl); }
            });

            // Calculate Invested Capital based on Filter
            let investedCap = 0;
            if (currentFilter === 'All') {
                investedCap = (balances["Day Trade"]||0) + (balances["Swing Trade"]||0) + (balances["Options"]||0);
            } else {
                investedCap = balances[currentFilter] || 0;
            }

            const totalTrades = wins + losses;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const avgWin = wins > 0 ? totalWinAmt / wins : 0;
            const avgLoss = losses > 0 ? totalLossAmt / losses : 0;
            const pf = totalLossAmt > 0 ? totalWinAmt / totalLossAmt : (totalWinAmt > 0 ? 99.99 : 0);
            
            const currentPort = investedCap + netProfit; 
            const totalRoi = investedCap > 0 ? (netProfit / investedCap) * 100 : 0;

            document.getElementById('stat-port-val').innerText = moneyFmt.format(currentPort);
            document.getElementById('stat-invested').innerText = `Cap: ${moneyFmt.format(investedCap)}`;
            
            document.getElementById('stat-net-profit').innerText = (netProfit>=0?'+':'') + moneyFmt.format(netProfit);
            document.getElementById('stat-net-profit').className = `text-3xl font-black ${netProfit>=0?'text-emerald-500':'text-rose-500'}`;
            
            document.getElementById('stat-roi').innerText = (totalRoi>=0?'+':'') + totalRoi.toFixed(2) + '%';
            document.getElementById('stat-roi').className = `text-3xl font-black ${totalRoi>=0?'text-emerald-500':'text-rose-500'}`;
            
            document.getElementById('stat-win-rate').innerText = winRate.toFixed(1) + '%';
            document.getElementById('stat-total-trades').innerText = `${filtered.length} Trades (${currentFilter})`;
            
            document.getElementById('stat-avg-win').innerText = moneyFmt.format(avgWin);
            document.getElementById('stat-avg-loss').innerText = moneyFmt.format(avgLoss);
            document.getElementById('stat-pf').innerText = pf.toFixed(2);
            document.getElementById('stat-max-win').innerText = moneyFmt.format(maxWin);
        }

        function renderTrades() {
            const list = document.getElementById('tx-list');
            list.innerHTML = '';
            const filtered = getFilteredTrades();

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-zinc-600 py-10 flex flex-col items-center gap-2"><i data-lucide="filter" class="w-8 h-8 opacity-30"></i><span>No ${currentFilter} trades</span></div>`;
                lucide.createIcons(); return;
            }

            filtered.forEach(t => {
                const isWin = t.pl >= 0;
                list.insertAdjacentHTML('beforeend', `
                    <div class="bg-zinc-800/30 border border-zinc-800 p-3 rounded-xl flex justify-between items-center hover:bg-zinc-800/60 transition-colors group">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 rounded-full ${isWin?'bg-emerald-500':'bg-rose-500'}"></div>
                            <div>
                                <div class="font-bold text-white text-sm">${t.ticker} <span class="text-[10px] bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-400 ml-1 border border-zinc-700">${t.type}</span></div>
                                <div class="text-[10px] text-zinc-500">${t.date} • ${t.strategy || 'No Strategy'}</div>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <div>
                                <div class="font-bold ${isWin?'text-emerald-400':'text-rose-400'} text-sm">${isWin?'+':''}${moneyFmt.format(t.pl)}</div>
                                <div class="text-[10px] text-zinc-500">${t.roi>0?'+':''}${t.roi}% ROI</div>
                            </div>
                            <button onclick="deleteTrade(${t.id})" class="text-zinc-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `);
            });
            lucide.createIcons();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('cal-month-year');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) { grid.insertAdjacentHTML('beforeend', `<div></div>`); }

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // Filter Logic for Calendar
                const filtered = getFilteredTrades();
                const dayTrades = filtered.filter(t => t.date === dateStr);
                
                let dayPL = 0;
                dayTrades.forEach(t => dayPL += t.pl);

                let bgClass = "bg-zinc-800/30 border-zinc-800/50";
                let textClass = "text-zinc-600";
                
                if (dayTrades.length > 0) {
                    textClass = "text-white font-bold";
                    if (dayPL > 0) bgClass = "bg-emerald-500/20 border-emerald-500/30";
                    else if (dayPL < 0) bgClass = "bg-rose-500/20 border-rose-500/30";
                    else bgClass = "bg-zinc-700";
                }

                // Added ONCLICK event to open trade modal with date
                grid.insertAdjacentHTML('beforeend', `
                    <div onclick="openAddTrade('${dateStr}')" class="cal-day ${bgClass} border rounded-lg h-full flex flex-col justify-between p-1 md:p-2 min-h-[60px] transition-all relative group">
                        <span class="text-[10px] ${textClass}">${d}</span>
                        ${dayTrades.length > 0 ? `<span class="text-[10px] font-bold self-end ${dayPL>=0?'text-emerald-400':'text-rose-400'}">${dayPL>=0?'+':''}${Math.round(dayPL)}</span>` : ''}
                        
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none">
                            <i data-lucide="plus" class="w-4 h-4 text-emerald-500/80"></i>
                        </div>
                    </div>
                `);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // --- BACKUP & RESTORE ---
        function saveData() {
            localStorage.setItem('ptj_trades', JSON.stringify(trades));
            // Balances are saved in saveFund
        }

        function exportData() {
            const data = { trades, balances };
            navigator.clipboard.writeText(JSON.stringify(data)).then(() => alert("✅ Copied to clipboard!"));
        }

        function importData() {
            const str = prompt("Paste your backup data here:");
            if(str) {
                try {
                    const data = JSON.parse(str);
                    if(Array.isArray(data.trades)) trades = data.trades;
                    if(data.balances) balances = data.balances;
                    
                    localStorage.setItem('ptj_balances', JSON.stringify(balances));
                    saveData();
                    renderAll();
                    alert("✅ Restore successful!");
                } catch(e) { alert("❌ Invalid data"); }
            }
        }
        
        function resetData() {
            if(confirm("⚠️ Delete ALL trades & funds?")) {
                localStorage.clear();
                window.location.reload();
            }
        }
    </script>
</body>
</html>

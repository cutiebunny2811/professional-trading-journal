<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // üî¥ ‡πÅ‡∏õ‡∏∞ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycby0HHsN8RL1eZBvBiLNYAUt_aGvTNRC1pwKRu0BoUPltT5lyRpFt2KkstDFEqcP0ug2Cw/exec";

        const CATEGORIES = ["‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î", "‡∏ú‡∏±‡∏Å", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
        const UNITS = ["‡∏Å‡∏Å.", "‡∏Å‡∏£‡∏±‡∏°", "‡∏•‡∏¥‡∏ï‡∏£", "‡∏°‡∏•.", "‡∏ä‡∏¥‡πâ‡∏ô", "‡∏Å‡∏•‡πà‡∏≠‡∏á", "‡∏ñ‡∏∏‡∏á", "‡∏Ç‡∏ß‡∏î", "‡πÅ‡∏ñ‡∏ß", "‡πÅ‡∏û‡πá‡∏Ñ"];
        const CAT_ACCENT = { "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå": "#D4846A", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î": "#6ABED4", "‡∏ú‡∏±‡∏Å": "#7EC8A0", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà": "#D4C896", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": "#89A8D4", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á": "#D4A06A", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": "#B49AD4", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "#7A7A8A" };
        
        // Icon Mapping (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ Lucide icon ‡∏ï‡∏£‡∏á‡πÜ)
        const CAT_ICON = { "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå": "beef", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î": "fish", "‡∏ú‡∏±‡∏Å": "leaf", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà": "milk", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": "glass-water", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á": "flame-kindling", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": "utensils-crossed", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "box" };

        const T = { bg: "#0C0C0E", surface: "#131316", elevated: "#1C1C22", border: "rgba(255,255,255,0.07)", borderHi: "rgba(255,255,255,0.13)", text: "#E2E2EC", muted: "#64647A", dim: "#38384A", accent: "#C8A96E", danger: "#D4726A", success: "#7EC8A0" };

        const sheetStyle = `
            @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&family=DM+Mono:wght@400;500&display=swap');
            *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
            body{margin:0;background:${T.bg};font-family:'DM Sans','Noto Sans Thai',sans-serif}
            input,select,button{font-family:'DM Sans','Noto Sans Thai',sans-serif}
            .row:hover .acts{opacity:1!important}
            @keyframes up{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
            @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        `;

        function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

        function BottomSheet({ onClose, children }) {
            return (
                <div onClick={onClose} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.8)", backdropFilter: "blur(16px)", zIndex: 200, display: "flex", alignItems: "flex-end", justifyContent: "center" }}>
                    <div onClick={e => e.stopPropagation()} style={{ background: T.elevated, borderTop: `1px solid ${T.borderHi}`, borderRadius: "14px 14px 0 0", padding: "28px 24px 36px", width: "100%", maxWidth: 560, animation: "slideUp 0.28s cubic-bezier(.32,.72,0,1)" }}>
                        {children}
                    </div>
                </div>
            );
        }

        // Helper component to render Lucide Icons in React
        function LucideIcon({ name, size = 16, color = "currentColor", strokeWidth = 1.6 }) {
            const iconRef = useRef(null);
            useEffect(() => { if (iconRef.current) lucide.createIcons(); }, [name]);
            return <i ref={iconRef} data-lucide={name} style={{ width: size, height: size, color: color }}></i>;
        }

        function App() {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAdd, setShowAdd] = useState(false);
            const [filterCat, setFilterCat] = useState("‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
            const [search, setSearch] = useState("");
            const [useModal, setUseModal] = useState(null);
            const [useAmount, setUseAmount] = useState("");
            const [topUpModal, setTopUpModal] = useState(null);
            const [topUpAmount, setTopUpAmount] = useState("");
            const [editModal, setEditModal] = useState(null);
            const [editForm, setEditForm] = useState({ name: "", note: "", category: "" });
            const [form, setForm] = useState({ name: "", qty: "", unit: "‡∏Å‡∏£‡∏±‡∏°", category: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", note: "" });
            const [toast, setToast] = useState(null);
            const [lastSync, setLastSync] = useState(null);

            const showToast = (msg, type = "ok") => { setToast({ msg, type }); setTimeout(() => setToast(null), 2800); };

            const loadItems = useCallback(async () => {
                try {
                    const r = await fetch(API_URL);
                    const data = await r.json();
                    setItems(data);
                    setLastSync(new Date());
                } catch (err) { console.error("Load failed", err); }
                setLoading(false);
            }, []);

            const syncToSheet = async (nextItems) => {
                setItems(nextItems);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveAll', items: nextItems })
                    });
                    setLastSync(new Date());
                } catch { showToast("‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "err"); }
            };

            useEffect(() => {
                loadItems();
                const t = setInterval(loadItems, 15000); 
                return () => clearInterval(t);
            }, [loadItems]);

            const handleAdd = async () => {
                if (!form.name.trim() || !form.qty) return;
                const it = { id: genId(), name: form.name.trim(), qty: parseFloat(form.qty), unit: form.unit, category: form.category, note: form.note };
                await syncToSheet([it, ...items]);
                setForm({ name: "", qty: "", unit: "‡∏Å‡∏£‡∏±‡∏°", category: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", note: "" });
                setShowAdd(false);
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${it.name} ‡πÅ‡∏•‡πâ‡∏ß`);
            };

            const handleUse = async () => {
                const amt = parseFloat(useAmount);
                const nq = Math.max(0, useModal.qty - amt);
                const next = items.map(i => i.id === useModal.id ? { ...i, qty: nq } : i);
                await syncToSheet(next);
                setUseModal(null); setUseAmount("");
                showToast(`‡πÉ‡∏ä‡πâ ${amt} ${useModal.unit}`);
            };

            const handleTopUp = async () => {
                const amt = parseFloat(topUpAmount);
                const next = items.map(i => i.id === topUpModal.id ? { ...i, qty: i.qty + amt } : i);
                await syncToSheet(next);
                setTopUpModal(null); setTopUpAmount("");
                showToast(`‡πÄ‡∏ï‡∏¥‡∏° +${amt} ${topUpModal.unit}`);
            };

            const handleEditSave = async () => {
                const next = items.map(i => i.id === editModal.id ? { ...i, name: editForm.name.trim(), note: editForm.note, category: editForm.category } : i);
                await syncToSheet(next);
                setEditModal(null);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleDelete = async (id, name) => {
                if(!confirm(`‡∏•‡∏ö ${name}?`)) return;
                await syncToSheet(items.filter(i => i.id !== id));
                showToast(`‡∏•‡∏ö ${name} ‡∏≠‡∏≠‡∏Å`, "dim");
            };

            const outOfStock = items.filter(i => i.qty === 0);
            const filtered = items.filter(i => (filterCat === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || i.category === filterCat) && i.name.toLowerCase().includes(search.toLowerCase()))
                                  .sort((a,b) => (a.qty===0?1:0)-(b.qty===0?1:0));

            const baseInp = { background: T.surface, border: `1px solid ${T.border}`, borderRadius: 8, padding: "11px 14px", color: T.text, fontSize: 14, outline: "none", width: "100%" };

            return (
                <div style={{ minHeight: "100vh", background: T.bg, color: T.text }}>
                    <style>{sheetStyle}</style>
                    <header style={{ position: "sticky", top: 0, zIndex: 100, background: `${T.bg}F0`, backdropFilter: "blur(24px)", borderBottom: `1px solid ${T.border}`, padding: "16px 20px" }}>
                        <div style={{ maxWidth: 560, margin: "0 auto", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                            <div>
                                <div style={{ fontSize: 16, fontWeight: 600 }}>‚ùÑÔ∏é&nbsp;&nbsp;‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</div>
                                <div style={{ fontSize: 11, color: T.muted }}>{items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ <span style={{ fontFamily: "'DM Mono'" }}>{lastSync?.toLocaleTimeString() || "‚Äî"}</span></div>
                            </div>
                            <div style={{ display: "flex", gap: 8 }}>
                                <button onClick={loadItems} style={{ background: "transparent", border: `1px solid ${T.border}`, borderRadius: 8, padding: "8px 12px", color: T.muted }}>‚Üª</button>
                                <button onClick={() => setShowAdd(true)} style={{ background: T.accent, border: "none", borderRadius: 8, color: "#000", padding: "8px 18px", fontWeight: 600, fontSize: 13 }}>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á</button>
                            </div>
                        </div>
                    </header>

                    <main style={{ maxWidth: 560, margin: "0 auto", padding: "20px 16px 80px" }}>
                        <input value={search} onChange={e => setSearch(e.target.value)} placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style={{ ...baseInp, marginBottom: 14, paddingLeft: 38, borderRadius: 10 }} />
                        
                        <div style={{ display: "flex", gap: 6, overflowX: "auto", marginBottom: 22, paddingBottom: 5 }}>
                            {["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", ...CATEGORIES].map(cat => (
                                <button key={cat} onClick={() => setFilterCat(cat)} style={{ background: filterCat === cat ? T.surface : "transparent", border: `1px solid ${filterCat === cat ? T.borderHi : T.border}`, borderRadius: 20, color: filterCat === cat ? T.text : T.muted, padding: "5px 14px", fontSize: 12, whiteSpace: "nowrap" }}>{cat}</button>
                            ))}
                        </div>

                        {loading ? <div style={{ textAlign: "center", color: T.dim, padding: 60 }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div> : (
                            <div style={{ borderRadius: 10, overflow: "hidden", border: `1px solid ${T.border}` }}>
                                {filtered.map((item, idx) => {
                                    const accent = CAT_ACCENT[item.category] || T.muted;
                                    const empty = item.qty === 0;
                                    return (
                                        <div key={item.id} className="row" style={{ background: T.surface, borderTop: idx > 0 ? `1px solid ${T.border}` : "none", borderLeft: `2px solid ${empty ? T.danger : accent}`, padding: "13px 14px", display: "flex", alignItems: "center", gap: 12, animation: "up 0.2s ease" }}>
                                            <div style={{ width: 36, height: 36, borderRadius: 9, flexShrink: 0, background: `${empty ? T.danger : accent}14`, border: `1px solid ${empty ? T.danger : accent}28`, display: "flex", alignItems: "center", justifyContent: "center" }}>
                                                <LucideIcon name={empty ? "x" : CAT_ICON[item.category]} color={empty ? T.danger : accent} size={16} />
                                            </div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: 14, fontWeight: 500, color: empty ? T.muted : T.text, textDecoration: empty ? "line-through" : "none" }}>{item.name}</div>
                                                <div style={{ fontSize: 12, color: empty ? T.danger : accent, fontFamily: "'DM Mono'", fontWeight: 500 }}>{empty ? "0" : item.qty} {item.unit}</div>
                                                {item.note && <div style={{ fontSize: 11, color: T.muted, marginTop: 3 }}>{item.note}</div>}
                                            </div>
                                            <div className="acts" style={{ display: "flex", gap: 5, opacity: 0.35 }}>
                                                <button onClick={() => { setTopUpModal(item); setTopUpAmount(""); }} style={{ background: `${T.success}15`, border: `1px solid ${T.success}28`, borderRadius: 6, color: T.success, padding: "5px 10px", fontWeight: "bold" }}>+</button>
                                                {!empty && <button onClick={() => { setUseModal(item); setUseAmount(""); }} style={{ background: T.elevated, border: `1px solid ${T.border}`, borderRadius: 6, color: T.muted, padding: "5px 10px", fontSize: 12 }}>‡πÉ‡∏ä‡πâ</button>}
                                                <button onClick={() => { setEditModal(item); setEditForm({ name: item.name, note: item.note || "", category: item.category }); }} style={{ color: T.muted }}><LucideIcon name="pencil" size={13} /></button>
                                                <button onClick={() => handleDelete(item.id, item.name)} style={{ color: T.dim }}>‚úï</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    {showAdd && (
                        <BottomSheet onClose={() => setShowAdd(false)}>
                            <div style={{ fontWeight: 600, marginBottom: 20 }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>
                            <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á" style={{ ...baseInp, marginBottom: 10 }} onChange={e => setForm({ ...form, name: e.target.value })} />
                            <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
                                <input placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" type="number" style={{ ...baseInp, flex: 1 }} onChange={e => setForm({ ...form, qty: e.target.value })} />
                                <select style={{ ...baseInp, flex: 1 }} onChange={e => setForm({ ...form, unit: e.target.value })}>
                                    {UNITS.map(u => <option key={u}>{u}</option>)}
                                </select>
                            </div>
                            <select style={{ ...baseInp, marginBottom: 15 }} onChange={e => setForm({ ...form, category: e.target.value })}>
                                {CATEGORIES.map(c => <option key={c}>{c}</option>)}
                            </select>
                            <input placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style={{ ...baseInp, marginBottom: 15 }} onChange={e => setForm({ ...form, note: e.target.value })} />
                            <button onClick={handleAdd} style={{ width: "100%", background: T.accent, padding: 15, borderRadius: 8, fontWeight: 600, color: "#000" }}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô</button>
                        </BottomSheet>
                    )}

                    {topUpModal && (
                        <BottomSheet onClose={() => setTopUpModal(null)}>
                            <div style={{ marginBottom: 15 }}>‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å: {topUpModal.name}</div>
                            <input type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°" style={{ ...baseInp, marginBottom: 15 }} onChange={e => setTopUpAmount(e.target.value)} />
                            <button onClick={handleTopUp} style={{ width: "100%", background: T.success, padding: 15, borderRadius: 8, color: "#000", fontWeight: 600 }}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°</button>
                        </BottomSheet>
                    )}

                    {useModal && (
                        <BottomSheet onClose={() => setUseModal(null)}>
                            <div style={{ marginBottom: 15 }}>‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á: {useModal.name}</div>
                            <input type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" style={{ ...baseInp, marginBottom: 15 }} onChange={e => setUseAmount(e.target.value)} />
                            <button onClick={handleUse} style={{ width: "100%", background: T.danger, padding: 15, borderRadius: 8, color: "#fff", fontWeight: 600 }}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</button>
                        </BottomSheet>
                    )}

                    {editModal && (
                        <BottomSheet onClose={() => setEditModal(null)}>
                            <div style={{ fontWeight: 600, marginBottom: 15 }}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: {editModal.name}</div>
                            <input value={editForm.name} style={{ ...baseInp, marginBottom: 10 }} onChange={e => setEditForm({ ...editForm, name: e.target.value })} />
                            <select value={editForm.category} style={{ ...baseInp, marginBottom: 10 }} onChange={e => setEditForm({ ...editForm, category: e.target.value })}>
                                {CATEGORIES.map(c => <option key={c}>{c}</option>)}
                            </select>
                            <textarea value={editForm.note} style={{ ...baseInp, height: 80, marginBottom: 15 }} onChange={e => setEditForm({ ...editForm, note: e.target.value })} placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" />
                            <button onClick={handleEditSave} style={{ width: "100%", background: T.accent, padding: 15, borderRadius: 8, color: "#000", fontWeight: 600 }}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </BottomSheet>
                    )}

                    {toast && <div style={{ position: "fixed", bottom: 28, left: "50%", transform: "translateX(-50%)", background: T.elevated, border: `1px solid ${T.borderHi}`, color: T.text, padding: "10px 20px", borderRadius: 20, fontSize: 13, zIndex: 300 }}>{toast.msg}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

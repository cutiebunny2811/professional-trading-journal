<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô - Clean Version</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap');
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{margin:0;background:#0C0C0E;font-family:'DM Sans','Noto Sans Thai',sans-serif;color:#E2E2EC}
        
        /* üõ†Ô∏è ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .row:hover .acts { opacity: 1 !important; }
        @keyframes up { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

    
        const API_URL = "https://script.google.com/macros/s/AKfycby0HHsN8RL1eZBvBiLNYAUt_aGvTNRC1pwKRu0BoUPltT5lyRpFt2KkstDFEqcP0ug2Cw/exec";

        const CATEGORIES = ["‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î", "‡∏ú‡∏±‡∏Å", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
        const UNITS = ["‡∏Å‡∏Å.", "‡∏Å‡∏£‡∏±‡∏°", "‡∏•‡∏¥‡∏ï‡∏£", "‡∏°‡∏•.", "‡∏ä‡∏¥‡πâ‡∏ô", "‡∏Å‡∏•‡πà‡∏≠‡∏á", "‡∏ñ‡∏∏‡∏á", "‡∏Ç‡∏ß‡∏î", "‡πÅ‡∏ñ‡∏ß", "‡πÅ‡∏û‡πá‡∏Ñ"];
        const CAT_ACCENT = { "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå": "#D4846A", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î": "#6ABED4", "‡∏ú‡∏±‡∏Å": "#7EC8A0", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà": "#D4C896", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": "#89A8D4", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á": "#D4A06A", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": "#B49AD4", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "#7A7A8A" };
        const CAT_ICON = { "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå": "beef", "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î": "fish", "‡∏ú‡∏±‡∏Å": "leaf", "‡∏ô‡∏°/‡πÑ‡∏Ç‡πà": "milk", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°": "glass-water", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á": "flame-kindling", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à": "utensils-crossed", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "box" };

        const T = { bg: "#0C0C0E", surface: "#131316", elevated: "#1C1C22", border: "rgba(255,255,255,0.07)", borderHi: "rgba(255,255,255,0.13)", muted: "#64647A", dim: "#38384A", accent: "#C8A96E", danger: "#D4726A", success: "#7EC8A0" };

        function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

        function BottomSheet({ onClose, children }) {
            return (
                <div onClick={onClose} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.85)", backdropFilter: "blur(12px)", zIndex: 200, display: "flex", alignItems: "flex-end", justifyContent: "center" }}>
                    <div onClick={e => e.stopPropagation()} style={{ background: T.elevated, borderTop: `1px solid ${T.borderHi}`, borderRadius: "20px 20px 0 0", padding: "28px 24px 40px", width: "100%", maxWidth: 560, animation: "slideUp 0.3s cubic-bezier(.32,.72,0,1)" }}>
                        {children}
                    </div>
                </div>
            );
        }

        function LucideIcon({ name, size = 16, color = "currentColor" }) {
            const iconRef = useRef(null);
            useEffect(() => { if (iconRef.current) lucide.createIcons(); }, [name]);
            return <i ref={iconRef} data-lucide={name} style={{ width: size, height: size, color: color }}></i>;
        }

        function App() {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAdd, setShowAdd] = useState(false);
            const [filterCat, setFilterCat] = useState("‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
            const [search, setSearch] = useState("");
            const [useModal, setUseModal] = useState(null);
            const [useAmount, setUseAmount] = useState("");
            const [topUpModal, setTopUpModal] = useState(null);
            const [topUpAmount, setTopUpAmount] = useState("");
            const [editModal, setEditModal] = useState(null);
            const [editForm, setEditForm] = useState({ name: "", note: "", category: "" });
            const [form, setForm] = useState({ name: "", qty: "", unit: "‡∏Å‡∏£‡∏±‡∏°", category: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", note: "" });
            const [toast, setToast] = useState(null);
            const [lastSync, setLastSync] = useState(null);

            const showToast = (msg, type = "ok") => { setToast({ msg, type }); setTimeout(() => setToast(null), 2800); };

            const loadItems = useCallback(async () => {
                try {
                    const r = await fetch(API_URL);
                    const data = await r.json();
                    setItems(data);
                    setLastSync(new Date());
                } catch (err) { console.error(err); }
                setLoading(false);
            }, []);

            const syncToSheet = async (nextItems) => {
                setItems(nextItems);
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveAll', items: nextItems }) });
                    setLastSync(new Date());
                } catch { showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "err"); }
            };

            useEffect(() => {
                loadItems();
                const t = setInterval(loadItems, 15000);
                return () => clearInterval(t);
            }, [loadItems]);

            const handleAdd = async () => {
                if (!form.name.trim() || !form.qty) return;
                const it = { id: genId(), name: form.name.trim(), qty: parseFloat(form.qty), unit: form.unit, category: form.category, note: form.note };
                await syncToSheet([it, ...items]);
                setForm({ name: "", qty: "", unit: "‡∏Å‡∏£‡∏±‡∏°", category: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", note: "" });
                setShowAdd(false);
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${it.name} ‡πÅ‡∏•‡πâ‡∏ß`);
            };

            const handleUse = async () => {
                const amt = parseFloat(useAmount);
                const nq = Math.max(0, useModal.qty - amt);
                await syncToSheet(items.map(i => i.id === useModal.id ? { ...i, qty: nq } : i));
                setUseModal(null); setUseAmount("");
                showToast(nq === 0 ? `${useModal.name} ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß` : `‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${amt}`);
            };

            const handleTopUp = async () => {
                const amt = parseFloat(topUpAmount);
                await syncToSheet(items.map(i => i.id === topUpModal.id ? { ...i, qty: i.qty + amt } : i));
                setTopUpModal(null); setTopUpAmount("");
                showToast(`‡πÄ‡∏ï‡∏¥‡∏° ${amt} ${topUpModal.unit}`);
            };

            const handleEditSave = async () => {
                await syncToSheet(items.map(i => i.id === editModal.id ? { ...i, name: editForm.name.trim(), note: editForm.note, category: editForm.category } : i));
                setEditModal(null);
                showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleDelete = async (id, name) => {
                if(!confirm(`‡∏•‡∏ö ${name}?`)) return;
                await syncToSheet(items.filter(i => i.id !== id));
            };

            const outOfStock = items.filter(i => i.qty === 0);
            const filtered = items.filter(i => (filterCat === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" || i.category === filterCat) && i.name.toLowerCase().includes(search.toLowerCase()))
                                  .sort((a,b) => (a.qty===0?1:0)-(b.qty===0?1:0));

            return (
                <div style={{ minHeight: "100vh", background: T.bg, paddingBottom: 60 }}>
                    <header style={{ position: "sticky", top: 0, zIndex: 100, background: `${T.bg}E0`, backdropFilter: "blur(20px)", borderBottom: `1px solid ${T.border}`, padding: "16px 20px" }}>
                        <div style={{ maxWidth: 560, margin: "0 auto", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                            <div>
                                <div style={{ fontWeight: 600, fontSize: 16 }}>‚ùÑÔ∏é&nbsp;&nbsp;‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</div>
                                <div style={{ fontSize: 11, color: T.muted }}>{items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ {lastSync?.toLocaleTimeString() || "‚Äî"}</div>
                            </div>
                            <div style={{ display: "flex", gap: 10 }}>
                                <button onClick={loadItems} style={{ border: `1px solid ${T.border}`, borderRadius: 8, padding: "8px 12px", color: T.muted }}>‚Üª</button>
                                <button onClick={() => setShowAdd(true)} style={{ background: T.accent, borderRadius: 8, color: "#000", padding: "8px 18px", fontWeight: 600, fontSize: 13 }}>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á</button>
                            </div>
                        </div>
                    </header>

                    <main style={{ maxWidth: 560, margin: "0 auto", padding: "20px 16px" }}>
                        <input value={search} onChange={e => setSearch(e.target.value)} placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô..." style={{ width: "100%", background: T.surface, border: `1px solid ${T.border}`, borderRadius: 12, padding: "12px 16px", color: "#fff", marginBottom: 18 }} />
                        
                        <div className="no-scrollbar" style={{ display: "flex", gap: 8, overflowX: "auto", marginBottom: 24 }}>
                            {["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", ...CATEGORIES].map(cat => (
                                <button key={cat} onClick={() => setFilterCat(cat)} style={{ background: filterCat === cat ? T.surface : "transparent", border: `1px solid ${filterCat === cat ? T.borderHi : T.border}`, borderRadius: 20, color: filterCat ===
